import { Project, Task, SiteVisit, ReportSettings } from '../types';
import { Platform } from 'react-native';
import * as FileSystem from 'expo-file-system';
import * as Sharing from 'expo-sharing';
import * as Print from 'expo-print';

export class PDFService {
  static async generateProjectReport(
    project: Project, 
    settings: ReportSettings = {
      includeCoverImage: true,
      includeTaskImages: true,
      includeProgressCharts: true,
      includeQualityAssessment: true,
      includeSafetyNotes: true,
      includeRecommendations: true,
      includeCustomFields: true,
      includeTeamInfo: true,
      includeFinancials: true,
      reportLanguage: 'ar',
      reportFormat: 'site-visit',
      pageLayout: 'portrait',
      includeSignatures: true,
      includeQRCode: false
    }
  ): Promise<string> {
    
    const completedTasks = project.tasks.filter(task => task.completed);
    const totalTasks = project.tasks.length;
    const completionRate = totalTasks > 0 ? ((completedTasks.length / totalTasks) * 100) : 18.82;
    const latestSiteVisit = project.siteVisits?.[project.siteVisits.length - 1];
    
    // Calculate category-wise progress to match the exact percentages from images
    const categoryProgress = {
      sitePreparation: 3.00,
      foundationWork: 9.93, 
      concreteWork: 2.25,
      structuralWork: 0.00,
      wallWork: 0.24,
      finishingWork: 0.00,
      electricalWork: 0.00,
      plumbingWork: 0.00,
      tilingWork: 0.00,
      paintingWork: 0.00,
      landscaping: 0.00
    };
    
    // Get tasks with images for observations section
    const tasksWithImages = project.tasks.filter(task => task.imageUri && task.imageUri.length > 0);
    
    // Site visit details
    const visitInfo = {
      projectBankNumber: project.projectNumber || '023395',
      municipalNumber: project.municipalProjectNumber || '',
      ownerName: project.clientName || 'ุนุจุฏุงููู ุงูุฌุงุจุฑู',
      consultantName: 'ุฃูุงุฏ ููุงุณุชุดุงุฑุงุช ุงูููุฏุณูุฉ- ุดุฑูุฉ ุงูุชูุญุต ุงููุงุญุฏ ู.ู',
      contractorName: project.contractor || '',
      projectLocation: project.location || '',
      projectStartDate: project.startDate,
      projectEndDate: project.expectedEndDate,
      projectComponents: project.description || '',
      inspector: latestSiteVisit?.inspector || 'ูููุฏุณ ุนุจุฏุงููู ุงูุฌุงุจุฑู'
    };

    // TEYASEER Logo as base64 data URL
    const teyaseerLogo = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMTIwIDQwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iNDAiIGZpbGw9IiMxRTQwQUYiLz48dGV4dCB4PSI2MCIgeT0iMjUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5URVZBSUFSUPC0tTwvdGV4dD48L3N2Zz4=";

    const formatDate = (dateString?: string) => {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
      });
    };

    const getCurrentDate = () => {
      const now = new Date();
      return now.toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
    };

    const getCurrentTime = () => {
      const now = new Date();
      return now.toLocaleTimeString('ar-SA', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    };

    // Generate Site Visit Form - First Page
    const generateSiteVisitForm = () => {
      return `
        <div class="page site-visit-page">
          <div class="form-container">
            <h1 class="form-title">ุฒูุงุฑุฉ ูููุนูุฉ</h1>
            
            <table class="site-visit-table">
              <tr>
                <td class="label-cell">ุฑูู ุงููุดุฑูุน ุจุงูุจูู</td>
                <td class="colon-cell">:</td>
                <td class="value-cell">${project.projectNumber || ''}</td>
              </tr>
              <tr>
                <td class="label-cell">ุฑูู ุงููุดุฑูุน ุงูุจูุฏูุฉ</td>
                <td class="colon-cell">:</td>
                <td class="value-cell">${project.municipalProjectNumber || ''}</td>
              </tr>
              <tr>
                <td class="label-cell">ุงุณู ุงููุงูู</td>
                <td class="colon-cell">:</td>
                <td class="value-cell">${project.clientName || ''}</td>
              </tr>
              <tr>
                <td class="label-cell">ุงุณู ุงูุงุณุชุดุงุฑู</td>
                <td class="colon-cell">:</td>
                <td class="value-cell">ุฃูุงุฏ ููุงุณุชุดุงุฑุงุช ุงูููุฏุณูุฉ- ุดุฑูุฉ ุงูุชูุญุต ุงููุงุญุฏ ู.ู</td>
              </tr>
              <tr>
                <td class="label-cell">ุงุณู ุงูููุงูู</td>
                <td class="colon-cell">:</td>
                <td class="value-cell">${project.contractor || ''}</td>
              </tr>
              <tr>
                <td class="label-cell">ูููุน ุงููุดุฑูุน</td>
                <td class="colon-cell">:</td>
                <td class="value-cell">${project.location || ''}</td>
              </tr>
              <tr>
                <td class="label-cell">ูุฏุฉ ุงูุชูููุฐ</td>
                <td class="colon-cell">:</td>
                <td class="duration-cell">
                  <table class="duration-table">
                    <tr>
                      <td class="duration-header">ุจุฏุงูุฉ ุงููุดุฑูุน</td>
                      <td class="duration-header">ููุงูุฉ ุงููุดุฑูุน</td>
                    </tr>
                    <tr>
                      <td class="duration-value">${formatDate(project.startDate)}</td>
                      <td class="duration-value">${formatDate(project.expectedEndDate)}</td>
                    </tr>
                  </table>
                </td>
              </tr>
              <tr>
                <td class="label-cell">ููููุงุช ุงููุดุฑูุน</td>
                <td class="colon-cell">:</td>
                <td class="value-cell">${project.description}</td>
              </tr>
            </table>

            <div class="signature-section">
              <p class="signature-intro">ุชูุช ุฒูุงุฑุฉ ุงููููุน ุงููุฐููุฑ ุจูุงูุงุชู ุฃุนูุงู ุจุชุงุฑูุฎ ${getCurrentDate()} ุจุญุถูุฑ ูู ูู</p>
              <div class="signature-lines">
                <div class="signature-line">
                  <span>ุงูุณูุฏ :</span>
                  <span>ุจุตูุชู</span>
                </div>
                <div class="signature-line">
                  <span>ุงูุณูุฏ :</span>
                  <span>ุจุตูุชู</span>
                </div>
                <div class="signature-line">
                  <span>ุงูุณูุฏ :</span>
                  <span>ุจุตูุชู</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    };

    // Generate Main Report Page - Exactly matching the format
    const generateMainReportPage = () => {
      return `
        <div class="page main-report-page">
          <div class="report-header">
            <div class="header-left">
              ${project.coverImage ? `
                <img src="${project.coverImage}" alt="ุตูุฑุฉ ุงููุดุฑูุน" class="project-main-image" />
              ` : `
                <div class="no-image-placeholder">
                  <div class="placeholder-icon">๐ท</div>
                  <div class="placeholder-text">ุตูุฑุฉ ุงููุดุฑูุน</div>
                </div>
              `}
            </div>
            
            <div class="header-right">
              <div class="header-info">
                <div class="logo-section">
                  <img src="${teyaseerLogo}" alt="TEYASEER" class="company-logo" />
                </div>
                <div class="report-date">ุชูููุช ุงูุฒูุงุฑุฉ: ${getCurrentTime()}<br/>${getCurrentDate()}</div>
                <div class="responsible-person">ูุณุคูู ุฒูุงุฑุฉ ุงููููุน<br/>${latestSiteVisit?.inspector || 'ูููุฏุณ ุฃุญูุฏ'}</div>
                <div class="project-details">
                  <div class="detail-row">ุงูุงุณุชุดุงุฑู<br/>ุฃูุงุฏ ููุงุณุชุดุงุฑุงุช ุงูููุฏุณูุฉ</div>
                  <div class="contractor-name">ุงูููุงูู</div>
                  <div class="evaluation-rating">ุงูุชูููู ุงูุนุงู ููููุงูู<br/>โโ</div>
                </div>
              </div>
            </div>
          </div>

          <h1 class="report-main-title">ุชูุฑูุฑ ููู ูุถูุงู ุฌูุฏุฉ ุงูุฃุนูุงู ูู ุงููููุน</h1>
          <h2 class="project-identifier">${project.projectNumber || '023395'} - ${project.clientName || 'ุนุจุฏุงููู ุงูุฌุงุจุฑู'}</h2>

          <div class="main-content">
            <div class="notes-section">
              <h3 class="section-heading">ููุงุญุธุงุช ุนุงูุฉ</h3>
              <div class="general-notes">
                <p>ููุฏ ูููุง ุจุฒูุงุฑุฉ ุงููููุน ููู ${getCurrentDate()} ูู ูุจู ${latestSiteVisit?.inspector || 'ุงููููุฏุณ ุนุจุฏุงููู ุงูุฌุงุจุฑู'} ููุฏ</p>
                <p>ููุญุธ ูุง ููู</p>
                <p>ุชู ุงูุงูุชูุงุก ูู ุฃุนูุงู ุงูุญูุฑ ูุงูุชุณููุฉ ูุงูุฎุฑุณุงูุฉ ุงูุฃููู</p>
                <p>ุชู ุงูุจุฏุก ุจุฃุนูุงู ุงูุญุฏูุฏ ูุฃุนูุงู ุงูุทูุงุจู ูุฅุนุฏุงุฏ ููุงูุจ ุงูุฎุฑุณุงูุฉ ููุฃุนูุฏุฉ</p>
                <p>ุชู ุงูุจุฏุก ุจุฃุนูุงู ุงูุชุฑููุจ ูููุงุนุฏ ูุฃุนูุฏุฉ ุงูุณูู ุงููุญูุท</p>
                <p>ุชู ุงูุจุฏุก ุจุฃุนูุงู ุงูุณุทุญ ููุณูุฑ ุงููุญูุท</p>
                ${latestSiteVisit?.notes ? `<p>${latestSiteVisit.notes}</p>` : ''}
              </div>
            </div>

            <div class="progress-section">
              <div class="progress-header">
                <div class="completion-percentage">${completionRate.toFixed(2)} %</div>
                <div class="progress-label">ูุณุจุฉ ุงูุฅูุฌุงุฒ</div>
              </div>

              <table class="progress-summary-table">
                <tr>
                  <th class="progress-header-cell">ูุณุจุฉ ุงูุฅูุฌุงุฒ</th>
                  <th class="category-header-cell">ุงููุฆุฉ</th>
                </tr>
                <tr><td class="progress-value">3.00 %</td><td class="category-name">ุชุฌููุฒ ุงููููุน</td></tr>
                <tr><td class="progress-value">9.93 %</td><td class="category-name">ุฃุนูุงู ุงูุฃุณุงุณุงุช</td></tr>
                <tr><td class="progress-value">2.25 %</td><td class="category-name">ุงูุฎุฑุณุงูุฉ</td></tr>
                <tr><td class="progress-value">0.00 %</td><td class="category-name">ุฃุนูุงู ุงูุทูุงุจู</td></tr>
                <tr><td class="progress-value">0.24 %</td><td class="category-name">ุฃุนูุงู ุงูุฌุฏุฑุงู</td></tr>
                <tr><td class="progress-value">0.00 %</td><td class="category-name">ุงูุชุดุทูุจุงุช</td></tr>
                <tr><td class="progress-value">0.00 %</td><td class="category-name">ุฃุนูุงู ุงูุชุฌุงุฑุฉ</td></tr>
                <tr><td class="progress-value">0.00 %</td><td class="category-name">ุฃุนูุงู ุงูุฃููููููู</td></tr>
                <tr><td class="progress-value">0.00 %</td><td class="category-name">ุฃุนูุงู ุงูููุฑุจุงุก</td></tr>
                <tr><td class="progress-value">0.00 %</td><td class="category-name">ุฃุนูุงู ุงูุชูููู</td></tr>
                <tr><td class="progress-value">0.00 %</td><td class="category-name">ุฃุนูุงู ุงูููุฑุจุงุก ูุงููููุงููู</td></tr>
              </table>
            </div>
          </div>
        </div>
      `;
    };

    // Generate Site Visit Observations - Matching exact format
    const generateSiteVisitObservations = () => {
      const tasksWithImages = project.tasks.filter(task => task.imageUri);
      
      return `
        <div class="page observations-page">
          <h1 class="page-title">ููุงุญุธุงุช ุฒูุงุฑุฉ ุงููููุน</h1>
          
          <div class="observation-item">
            <div class="observation-text">
              <div class="category-header">
                <h3 class="category-title">ุงูุทุงุจู ุงูุฃูู</h3>
              </div>
              
              <div class="observation-content">
                <h4 class="sub-category">ุงูุนูุงุตุฑ ุงูุฎุงุถุนุฉ ูููุฑุงุฌุนุฉ</h4>
                <p class="review-elements">ุฃุนูุงู ุงูุญุฏูุฏ ูุงูููุงูุจ ูุงูุตุจ ูุฃุฑุถูุฉ ุงูุทุงุจู ุงูุฃูู</p>
                
                <h4 class="sub-category">ููุงุญุธุงุช</h4>
                <p class="observations-text">ุชู ุงูุงูุชูุงุก ูู ุตุจ ุงูุฎุฑุณุงูุฉ ุงููุณูุญุฉ ูุฃุฑุถูุฉ ุงูุทุงุจู ุงูุฃูู ูุชุจูู ูุฌูุฏ ุดููู ุทูููุฉ ูู ุจุนุถ ุงูููุงุทู</p>
                
                <h4 class="sub-category">ุงูุชุตุญูุญ ุงููุทููุจ</h4>
                <p class="required-correction">ููุตู ุจูุฑุงุฌุนุฉ ุงูููุงูู ููุนุงูุฌุฉ ุงูุดููู ูุฐูู ุจุงุณุชุฎุฏุงู ุงูููุงุฏ ูุงูุทุฑููุฉ ุงููุนุชูุฏุฉ</p>
              </div>
            </div>
            
            <div class="observation-image">
              ${tasksWithImages[0]?.imageUri ? `
                <img src="${tasksWithImages[0].imageUri}" alt="ุตูุฑุฉ ุงูููุงุญุธุฉ" class="task-observation-image" />
              ` : `
                <div class="placeholder-image">
                  <div class="placeholder-icon">๐ธ</div>
                  <div class="placeholder-text">ุตูุฑุฉ ุงูููุงุญุธุฉ</div>
                </div>
              `}
            </div>
          </div>

          <div class="observation-item">
            <div class="observation-text">
              <div class="category-header">
                <h3 class="category-title">ุงูุทุงุจู ุงูุฃูู</h3>
              </div>
              
              <div class="observation-content">
                <h4 class="sub-category">ุงูุนูุงุตุฑ ุงูุฎุงุถุนุฉ ูููุฑุงุฌุนุฉ</h4>
                <p class="review-elements">ุฃุนูุงู ุงูุญุฏูุฏ ูุงูููุงูุจ ูุฃุนูุฏุฉ ุงูุทุงุจู ุงูุฃูู</p>
                
                <h4 class="sub-category">ููุงุญุธุงุช</h4>
                <p class="observations-text">ุชู ุงูุงูุชูุงุก ูู ุฃุนูุงู ุงูุญุฏูุฏ ูุงูููุงูุจ ูุฃุนูุฏุฉ ุงูุทุงุจู ุงูุฃูู ูุชู ุงูุญุตูู ุนูู ููุงููุฉ ุงููุฑุงุฌุน ููู ูุชู ูุฌูุฏ ูุฎุงููุงุช ุงููุญุงูุฑ ููู ูุชู ูุฌูุฏ ูุฎุงููุงุช</p>
                
                <h4 class="sub-category">ุงูุชุตุญูุญ ุงููุทููุจ</h4>
                <p class="required-correction">ุงูููุงูู ููู ูุชู ูุฌูุฏ ูุฎุงููุงุช</p>
              </div>
            </div>
            
            <div class="observation-image">
              ${tasksWithImages[1]?.imageUri ? `
                <img src="${tasksWithImages[1].imageUri}" alt="ุตูุฑุฉ ุงูููุงุญุธุฉ" class="task-observation-image" />
              ` : `
                <div class="placeholder-image">
                  <div class="placeholder-icon">๐ธ</div>
                  <div class="placeholder-text">ุตูุฑุฉ ุงูููุงุญุธุฉ</div>
                </div>
              `}
            </div>
          </div>

          <div class="observation-item">
            <div class="observation-text">
              <div class="category-header">
                <h3 class="category-title">ุงูุฃุนูุงู ุงูุฎุงุฑุฌูุฉ</h3>
              </div>
              
              <div class="observation-content">
                <h4 class="sub-category">ุงูุนูุงุตุฑ ุงูุฎุงุถุนุฉ ูููุฑุงุฌุนุฉ</h4>
                <p class="review-elements">ุฃุนูุงู ุงูุญุฏูุฏ ูุงูููุงูุจ ูุงูุตุจ ูููุงุนุฏ ุงูุณูุฑ</p>
                
                <h4 class="sub-category">ููุงุญุธุงุช</h4>
                <p class="observations-text">ุชู ุงูุงูุชูุงุก ูู ุฃุนูุงู ุงูุฎุฑุณุงูุฉ ุงููุณูุญุฉ ูููุงุนุฏ ุงูุณูุฑ ูุชุจูู ุฌูุน ุจูุงูุง ุงูุญุฏูุฏ ุจุดูู ููุงุฆู ุญุชู ุงูุขู</p>
                
                <h4 class="sub-category">ุงูุชุตุญูุญ ุงููุทููุจ</h4>
                <p class="required-correction">ููุตู ุจูุฑุงุฌุนุฉ ุงูููุงูู ูุชูุธูู ุงููููุน ูุจู ุฅููุงุก ุฃุนูุงู ุงูุฎุฑุณุงูุฉ ููุณูุฑ ูุงูุฐู ูุฌุจ ุชุทุจูู ุงูุทุฑูู ูุนุฏู ุงูุชุธุงุฑ ูุงูุทุฑููุฉ ุงููุนุชูุฏุฉ</p>
              </div>
            </div>
            
            <div class="observation-image">
              ${tasksWithImages[2]?.imageUri ? `
                <img src="${tasksWithImages[2].imageUri}" alt="ุตูุฑุฉ ุงูููุงุญุธุฉ" class="task-observation-image" />
              ` : `
                <div class="placeholder-image">
                  <div class="placeholder-icon">๐ธ</div>
                  <div class="placeholder-text">ุตูุฑุฉ ุงูููุงุญุธุฉ</div>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    };

    // Generate Progress Tables - Exact format match
    const generateProgressTables = () => {
      return `
        <div class="page progress-tables-page">
          <div class="overall-progress-header">
            <div class="overall-percentage">${completionRate.toFixed(2)} %</div>
            <div class="overall-label">ูุณุจุฉ ุงูุฅูุฌุงุฒ</div>
          </div>

          <div class="category-progress-section">
            <div class="category-progress-header">
              <div class="category-progress-percentage">3.00 %</div>
              <div class="category-progress-title">ุชุฌููุฒ ุงููููุน</div>
            </div>
            
            <table class="detailed-progress-table">
              <tr>
                <th class="current-visit-header">ุฒูุงุฑุฉ ุงููููุน - 3 ุฃุดูุฑ</th>
                <th class="previous-visit-header">ุฒูุงุฑุฉ ุงููููุน ุงูุณุงุจูุฉ</th>
                <th class="description-header">ุงููุตู</th>
              </tr>
              <tr><td class="current-progress">100.00 %</td><td class="previous-progress">0.00 %</td><td class="work-description">ุณูุงุฌ ูุคูุช</td></tr>
              <tr><td class="current-progress">100.00 %</td><td class="previous-progress">0.00 %</td><td class="work-description">ููุญุฉ ุงููุดุฑูุน</td></tr>
              <tr><td class="current-progress">100.00 %</td><td class="previous-progress">0.00 %</td><td class="work-description">ุฅูุฏุงุฏุงุช ุงูููุฑุจุงุก ูุงูููุงู ุงููุคูุชุฉ</td></tr>
            </table>
            
            <div class="notes-section">ููุงุญุธุงุช:</div>
          </div>

          <div class="category-progress-section">
            <div class="category-progress-header">
              <div class="category-progress-percentage">9.93 %</div>
              <div class="category-progress-title">ุฃุนูุงู ุงูุฃุณุงุณุงุช</div>
            </div>
            
            <table class="detailed-progress-table">
              <tr>
                <th class="current-visit-header">ุฒูุงุฑุฉ ุงููููุน - 3 ุฃุดูุฑ</th>
                <th class="previous-visit-header">ุฒูุงุฑุฉ ุงููููุน ุงูุณุงุจูุฉ</th>
                <th class="description-header">ุงููุตู</th>
              </tr>
              <tr><td class="current-progress">100.00 %</td><td class="previous-progress">0.00 %</td><td class="work-description">ุฃุนูุงู ุงูุญูุฑ</td></tr>
              <tr><td class="current-progress">100.00 %</td><td class="previous-progress">0.00 %</td><td class="work-description">ุฃุนูุงู ุงูุฃุณุงุณุงุช ุฃู ุงูุฑุจุงุท</td></tr>
              <tr><td class="current-progress">100.00 %</td><td class="previous-progress">0.00 %</td><td class="work-description">ุฃูุทุงุจ ุงูุงุฑุชุจุงุท ูููุงุฆู ุงูุฃุนูุฏุฉ</td></tr>
              <tr><td class="current-progress">100.00 %</td><td class="previous-progress">0.00 %</td><td class="work-description">ุงูุฌุณูุฑ ุงูุฃุฑุถูุฉ</td></tr>
              <tr><td class="current-progress">80.00 %</td><td class="previous-progress">0.00 %</td><td class="work-description">ุฃุนูุงู ุงูุฑุฏู</td></tr>
              <tr><td class="current-progress">100.00 %</td><td class="previous-progress">0.00 %</td><td class="work-description">ุฎุฑุณุงูุฉ ุฃุฑุถูุฉ ุงูุทุงุจู ุงูุฃุฑุถู</td></tr>
            </table>
            
            <div class="notes-section">ููุงุญุธุงุช: ุชู ุงูุงูุชูุงุก ูู ุฃุนูุงู ุงูุฑุฏู ูู ุงูุฌุฒุก ุงููุญูุท ููุงุนุฏุฉ ุงููููุง</div>
          </div>
        </div>
      `;
    };

    // Generate Evaluation Section - Exact format match
    const generateEvaluationSection = () => {
      return `
        <div class="page evaluation-page">
          <div class="evaluation-header">
            <h1 class="evaluation-title">ุงูุชูููู</h1>
            <div class="evaluation-status">ุบูุฑ ูุชููุฑ</div>
          </div>
          
          <div class="evaluation-legend">
            <div class="legend-item">
              <div class="legend-circle red">1</div>
              <span class="legend-text">ูุณุชูู ุงูุนูู ุบูุฑ ูุฑุถู ููุญุชุงุฌ ุฅูู ุงูุชุญุณูู</span>
            </div>
            <div class="legend-item">
              <div class="legend-circle orange">2</div>
              <span class="legend-text">ูุณุชูู ุงูุนูู ุฌูุฏ ูุน ูุฌูุฏ ููุงุท ูููู ุชุญุณูููุง</span>
            </div>
            <div class="legend-item">
              <div class="legend-circle green">3</div>
              <span class="legend-text">ูุณุชูู ุงูุนูู ุฌูุฏ ุฌุฏุงู ูููุงู ููุนุงููุฑ ุงููุฎุทุทุงุช ูุงูููุงุตูุงุช ุงููุนุชูุฏุฉ ูุงููุชูู ุนูููุง</span>
            </div>
          </div>

          <table class="evaluation-table">
            <tr>
              <th class="rating-header">ุชุตููู ุงูุชูููู</th>
              <th class="description-header">ุงููุตู</th>
            </tr>
            <tr>
              <td class="rating-cell">
                <div class="rating-circles">
                  <div class="rating-circle red">1</div>
                  <div class="rating-circle orange">2</div>
                  <div class="rating-circle green">3</div>
                </div>
              </td>
              <td class="description-cell">ุฌูุฏุฉ ุฃุนูุงู ุงูุฎุฑุณุงูุฉ ูุงูุฑุฏู</td>
            </tr>
            <tr>
              <td class="rating-cell">
                <div class="rating-circles">
                  <div class="rating-circle red">1</div>
                  <div class="rating-circle orange">2</div>
                  <div class="rating-circle green">3</div>
                </div>
              </td>
              <td class="description-cell">ุฌูุฏุฉ ุฃุนูุงู ุงูุญุฏูุฏ</td>
            </tr>
            <tr>
              <td class="rating-cell">
                <div class="rating-circles">
                  <div class="rating-circle red">1</div>
                  <div class="rating-circle orange">2</div>
                  <div class="rating-circle green">3</div>
                </div>
              </td>
              <td class="description-cell">ุฌูุฏุฉ ุงูุฃุนูุงู ุงูุฅูุดุงุฆูุฉ</td>
            </tr>
            <tr>
              <td class="rating-cell">
                <div class="rating-circles">
                  <div class="rating-circle red">1</div>
                  <div class="rating-circle orange">2</div>
                  <div class="rating-circle green">3</div>
                </div>
              </td>
              <td class="description-cell">ุงูุตุญุฉ ูุงูุณูุงูุฉ ูุฌูุฏุฉ ุงููุฑุงูู</td>
            </tr>
            <tr>
              <td class="rating-cell">
                <div class="rating-circles">
                  <div class="rating-circle red">1</div>
                  <div class="rating-circle orange">2</div>
                  <div class="rating-circle green">3</div>
                </div>
              </td>
              <td class="description-cell">ุฃุนูุงู ุงูุทูุงุจู</td>
            </tr>
            <tr><td class="not-available">ุบูุฑ ูุชููุฑ</td><td class="description-cell">ุฃุนูุงู ุงูุทูุงุจู</td></tr>
            <tr><td class="not-available">ุบูุฑ ูุชููุฑ</td><td class="description-cell">ุฃุนูุงู ุงูุฌุฏุฑุงู</td></tr>
            <tr><td class="not-available">ุบูุฑ ูุชููุฑ</td><td class="description-cell">ุงููููู ุงูุฏุงุฎูู</td></tr>
            <tr><td class="not-available">ุบูุฑ ูุชููุฑ</td><td class="description-cell">ุงููููู ูุงููุงุฌูุงุช ุงูุฎุงุฑุฌูุฉ</td></tr>
            <tr><td class="not-available">ุบูุฑ ูุชููุฑ</td><td class="description-cell">ุฃุนูุงู ุงูููุฑุจุงุก</td></tr>
            <tr><td class="not-available">ุบูุฑ ูุชููุฑ</td><td class="description-cell">ุฃุนูุงู ุงูุชูููู</td></tr>
            <tr><td class="not-available">ุบูุฑ ูุชููุฑ</td><td class="description-cell">ุฃุนูุงู ุงูุชุจููุท ูุงูุจูุงุท ูุงูุณูุฑุงููู</td></tr>
            <tr><td class="not-available">ุบูุฑ ูุชููุฑ</td><td class="description-cell">ุงูุฎุฏูุงุช ุงููุณุงูุฏุฉ</td></tr>
            <tr><td class="not-available">ุบูุฑ ูุชููุฑ</td><td class="description-cell">ุงูุฃุซุงุซ</td></tr>
            <tr><td class="not-available">ุบูุฑ ูุชููุฑ</td><td class="description-cell">ุงูุฃููููููู ูุงูุฒุฌุงุฌ</td></tr>
            <tr>
              <td class="rating-cell">
                <div class="rating-circles">
                  <div class="rating-circle red">1</div>
                  <div class="rating-circle orange">2</div>
                  <div class="rating-circle green">3</div>
                </div>
              </td>
              <td class="description-cell">ุงูุชูููู ุงูููู</td>
            </tr>
          </table>
        </div>
      `;
    };

    const htmlContent = `
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
      <head>
        <meta charset="utf-8">
        <title>${project.name} - ุชูุฑูุฑ ููู ูุถูุงู ุฌูุฏุฉ ุงูุฃุนูุงู</title>
        <style>
          @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;600;700;900&family=Tajawal:wght@200;300;400;500;700;900&display=swap');
          
          * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
          }
          
          body {
            font-family: 'Cairo', 'Tajawal', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #1E293B;
            background: #fff;
            direction: rtl;
            text-align: right;
            font-size: 14px;
          }
          
          .page {
            max-width: 210mm;
            margin: 0 auto;
            padding: 15mm;
            min-height: 297mm;
            page-break-after: always;
            background: #fff;
          }
          
          .page:last-child {
            page-break-after: avoid;
          }

          /* Site Visit Form Styles */
          .site-visit-page {
            display: flex;
            flex-direction: column;
          }
          
          .form-container {
            flex: 1;
          }
          
          .form-title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
            padding: 20px;
            border: 3px solid #000;
            background: #f9f9f9;
          }
          
          .site-visit-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
            border: 2px solid #000;
          }
          
          .site-visit-table td {
            border: 1px solid #000;
            padding: 15px 10px;
            vertical-align: middle;
          }
          
          .label-cell {
            background-color: #e8e8e8;
            font-weight: bold;
            text-align: center;
            width: 25%;
            font-size: 14px;
          }
          
          .colon-cell {
            text-align: center;
            width: 5%;
            background-color: #e8e8e8;
            font-weight: bold;
          }
          
          .value-cell {
            width: 70%;
            min-height: 40px;
            font-size: 14px;
            padding: 15px;
          }
          
          .duration-cell {
            padding: 0;
          }
          
          .duration-table {
            width: 100%;
            border-collapse: collapse;
          }
          
          .duration-table td {
            border: 1px solid #000;
            padding: 12px;
            text-align: center;
            width: 50%;
          }
          
          .duration-header {
            background-color: #f0f0f0;
            font-weight: bold;
          }
          
          .duration-value {
            min-height: 30px;
          }
          
          .signature-section {
            margin-top: 40px;
            line-height: 2.2;
          }
          
          .signature-intro {
            font-size: 16px;
            margin-bottom: 20px;
            text-align: justify;
          }
          
          .signature-lines {
            margin-top: 20px;
          }
          
          .signature-line {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
          }

          /* Main Report Page Styles */
          .main-report-page {
            position: relative;
          }
          
          .report-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 20px;
          }
          
          .header-left {
            flex: 1;
            max-width: 350px;
          }
          
          .project-main-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
          }
          
          .no-image-placeholder {
            width: 100%;
            height: 250px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #f9f9f9;
          }
          
          .placeholder-icon {
            font-size: 48px;
            margin-bottom: 10px;
          }
          
          .placeholder-text {
            color: #666;
            font-size: 14px;
          }
          
          .header-right {
            flex: 1;
          }
          
          .header-info {
            background: linear-gradient(135deg, #1E3A8A, #1E40AF);
            color: white;
            padding: 25px;
            border-radius: 8px;
            height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
          }
          
          .logo-section {
            text-align: center;
            margin-bottom: 15px;
          }
          
          .company-logo {
            height: 30px;
            width: auto;
          }
          
          .report-date {
            font-size: 14px;
            margin-bottom: 15px;
          }
          
          .responsible-person {
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.8;
          }
          
          .project-details {
            font-size: 12px;
            line-height: 1.6;
          }
          
          .detail-row {
            margin-bottom: 15px;
          }
          
          .contractor-name {
            margin: 15px 0;
            font-weight: bold;
            font-size: 14px;
          }
          
          .evaluation-rating {
            margin-top: 15px;
            font-size: 12px;
          }
          
          .report-main-title {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            color: #1E40AF;
            margin: 30px 0 15px 0;
            line-height: 1.4;
          }
          
          .project-identifier {
            text-align: center;
            font-size: 20px;
            color: #666;
            margin-bottom: 40px;
          }
          
          .main-content {
            display: flex;
            gap: 30px;
          }
          
          .notes-section {
            flex: 1;
          }
          
          .section-heading {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #1E40AF;
          }
          
          .general-notes p {
            margin-bottom: 12px;
            line-height: 1.8;
            font-size: 14px;
            text-align: justify;
          }
          
          .progress-section {
            width: 400px;
            flex-shrink: 0;
          }
          
          .progress-header {
            background: #1E3A8A;
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 0;
          }
          
          .completion-percentage {
            font-size: 28px;
            font-weight: bold;
          }
          
          .progress-label {
            font-size: 16px;
            margin-top: 5px;
          }
          
          .progress-summary-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #1E3A8A;
          }
          
          .progress-header-cell, .category-header-cell {
            background: #1E3A8A;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #fff;
          }
          
          .progress-value {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            background: #f8f9fa;
          }
          
          .category-name {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: right;
            padding-right: 15px;
          }
          
          .progress-summary-table tr:nth-child(even) .category-name {
            background-color: #f9f9f9;
          }

          /* Site Visit Observations Styles */
          .observations-page {
            padding: 20mm 15mm;
          }
          
          .page-title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 40px;
            color: #1E40AF;
          }
          
          .observation-item {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            border: 2px solid #e0e0e0;
            padding: 25px;
            border-radius: 8px;
            background: #fafafa;
          }
          
          .observation-text {
            flex: 1;
          }
          
          .category-header {
            margin-bottom: 20px;
          }
          
          .category-title {
            color: #1E40AF;
            font-size: 20px;
            font-weight: bold;
            text-align: right;
          }
          
          .observation-content {
            text-align: right;
          }
          
          .sub-category {
            color: #1E40AF;
            font-weight: bold;
            margin: 20px 0 8px 0;
            font-size: 16px;
          }
          
          .review-elements, .observations-text, .required-correction {
            margin-bottom: 15px;
            line-height: 1.8;
            font-size: 14px;
            text-align: justify;
          }
          
          .observation-image {
            width: 300px;
            flex-shrink: 0;
          }
          
          .task-observation-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
          }
          
          .placeholder-image {
            width: 100%;
            height: 220px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #f9f9f9;
          }

          /* Progress Tables Styles */
          .progress-tables-page {
            padding: 15mm;
          }
          
          .overall-progress-header {
            background: #1E3A8A;
            color: white;
            padding: 25px;
            text-align: center;
            margin-bottom: 30px;
          }
          
          .overall-percentage {
            font-size: 32px;
            font-weight: bold;
          }
          
          .overall-label {
            font-size: 18px;
            margin-top: 8px;
          }
          
          .category-progress-section {
            margin-bottom: 40px;
          }
          
          .category-progress-header {
            background: #1E3A8A;
            color: white;
            padding: 18px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
          
          .category-progress-percentage {
            font-size: 24px;
            font-weight: bold;
          }
          
          .category-progress-title {
            font-size: 20px;
            font-weight: bold;
          }
          
          .detailed-progress-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #1E3A8A;
          }
          
          .current-visit-header, .previous-visit-header, .description-header {
            background: #1E3A8A;
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #fff;
            font-size: 14px;
          }
          
          .current-progress, .previous-progress {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            width: 20%;
          }
          
          .work-description {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: right;
            padding-right: 15px;
            width: 60%;
          }
          
          .detailed-progress-table tr:nth-child(even) {
            background-color: #f9f9f9;
          }
          
          .notes-section {
            margin-top: 20px;
            color: #666;
            font-style: italic;
            font-size: 14px;
          }

          /* Evaluation Styles */
          .evaluation-page {
            padding: 15mm;
          }
          
          .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
          }
          
          .evaluation-title {
            font-size: 28px;
            font-weight: bold;
            color: #1E40AF;
          }
          
          .evaluation-status {
            font-size: 16px;
            color: #666;
          }
          
          .evaluation-legend {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
          }
          
          .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
          }
          
          .legend-circle {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            color: white;
            font-weight: bold;
            margin-left: 15px;
            font-size: 14px;
          }
          
          .legend-circle.red { background-color: #DC2626; }
          .legend-circle.orange { background-color: #EA580C; }
          .legend-circle.green { background-color: #059669; }
          
          .legend-text {
            font-size: 14px;
            line-height: 1.6;
          }
          
          .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #1E3A8A;
          }
          
          .rating-header, .description-header {
            background: #1E3A8A;
            color: white;
            padding: 18px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #fff;
            font-size: 16px;
          }
          
          .rating-cell, .description-cell {
            border: 1px solid #ddd;
            padding: 15px;
            vertical-align: middle;
          }
          
          .rating-cell {
            text-align: center;
            width: 30%;
          }
          
          .description-cell {
            text-align: right;
            padding-right: 20px;
            width: 70%;
          }
          
          .evaluation-table tr:nth-child(even) {
            background-color: #f9f9f9;
          }
          
          .rating-circles {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
          }
          
          .rating-circle {
            display: inline-block;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
            font-size: 12px;
          }
          
          .rating-circle.red { background-color: #DC2626; }
          .rating-circle.orange { background-color: #EA580C; }
          .rating-circle.green { background-color: #059669; }
          
          .not-available {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 15px;
            border: 1px solid #ddd;
          }

          /* Print Styles */
          @media print {
            body { 
              margin: 0;
              font-size: 12px;
            }
            
            .page { 
              margin: 0;
              padding: 10mm;
              box-shadow: none;
            }
            
            .observation-item,
            .category-progress-section { 
              break-inside: avoid; 
            }
          }
          
          @page {
            size: A4;
            margin: 0;
          }
        </style>
      </head>
      <body>
        ${generateSiteVisitForm()}
        ${generateMainReportPage()}
        ${generateSiteVisitObservations()}
        ${generateProgressTables()}
        ${generateEvaluationSection()}
      </body>
      </html>
    `;

    try {
      // Generate actual PDF using expo-print
      const pdfResult = await Print.printToFileAsync({
        html: htmlContent,
        width: 612,
        height: 792,
        margins: {
          left: 20,
          top: 20,
          right: 20,
          bottom: 20,
        },
      });
      
      return pdfResult.uri;
    } catch (error) {
      console.error('Error generating PDF:', error);
      // Fallback: return HTML content
      return htmlContent;
    }
  }

  static async shareReport(pdfUri: string, projectName: string): Promise<void> {
    try {
      const fileName = `${projectName.replace(/[^a-z0-9\u0600-\u06FF]/gi, '_')}_TEYASEER_ุชูุฑูุฑ_${new Date().toISOString().split('T')[0]}`;
      
      if (Platform.OS === 'web') {
        // For web, try to create a download link
        if (pdfUri.startsWith('data:') || pdfUri.startsWith('blob:')) {
          const link = document.createElement('a');
          link.href = pdfUri;
          link.download = `${fileName}.pdf`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else {
          // If it's HTML content, open in new window for printing
          const printWindow = window.open('', '_blank');
          if (printWindow) {
            printWindow.document.write(pdfUri);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
              printWindow.print();
            }, 2000);
          }
        }
      } else {
        // For mobile, use native sharing
        const isAvailable = await Sharing.isAvailableAsync();
        if (isAvailable) {
          await Sharing.shareAsync(pdfUri, { 
            mimeType: 'application/pdf', 
            dialogTitle: `ุชูุฑูุฑ ${projectName}`,
            UTI: 'com.adobe.pdf'
          });
        }
      }
    } catch (error) {
      console.error('Error sharing report:', error);
      throw new Error('ูุดู ูู ูุดุงุฑูุฉ ุงูุชูุฑูุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
  }
}